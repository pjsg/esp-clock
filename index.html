<html><head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<style>
body {
  font-family: sans-serif;
}
.led {
    height: 25px;
    width: 25px;
    background-color: #fff;
    border-radius: 50%;
    display: inline-block;
    vertical-align: middle;
}

#display {
    border: 1px solid;
    vertical-align: middle;
}
input.narrow {
  width: 3em;
}
</style>
</head><body>
<h1>Clock</h1>
MAC: <span id="mac"></span><br>

Timezone: <span id="tz"></span><br>
Last sync: <span id="lastsync"></span><br>
Now: <span id="now"></span><br>
Clock: <input class=narrow id=chr type=number min=0 max=11></input>:<input class=narrow id=cmn type=number min=0 max=60></input>:<input class=narrow id=csc type=number min=0 max=60></input>
<button type="button" id="set">Set</button>

<br>Front Panel<br>
<div>
<span id=led0 class="led"></span>
<canvas id=display width=128 height=64 ></canvas>
<span id=led1 class="led"/></span>
<span id=led2 class="led"/></span>
</div>

<br>
    
<button type="button" id="stop">Stop</button>
<button type="button" id="start">Start</button>
<script>
var sample = 
{
    "mac": "5c:cf:7f:23:82:50",
    "config": {
        "tz": "eastern"
    },
    "time": [
        1483224410,
        318719,
        -12044
    ],
    "running": 1,
    "hms": 20810,
    "freemem": 15584,
    "ntp": {
        "usecs": 720661,
        "secs": 1483223883,
        "info": {
            "pending_leap": 1,
            "stratum": 1,
            "offset_us": -136,
            "root_maxerr_us": 457,
            "root_dispersion_us": 0,
            "root_delay_us": 0,
            "delay_us": 915,
            "leap": 1
        },
        "server": "192.168.1.21"
    }
};

var display;

function rleDecode(ctx, b) {
  ctx.fillStyle = 'rgb(255,255,255)';
  ctx.fillRect(0, 0, 128, 64);

  ctx.translate(64, 32);
  ctx.rotate(Math.PI);
  ctx.translate(-64, -32);
  ctx.beginPath();
  var row = 0;
  for (var i = 0; i < b.length; ) {
    var ents = b.charCodeAt(i++);
    for (var e = 0; e < ents; e++) {
      var col = b.charCodeAt(i++);
      var npix = b.charCodeAt(i++);

      ctx.moveTo(col, row);
      ctx.lineTo(col + npix, row);
    }

    row++;
  }
  ctx.stroke();
  ctx.resetTransform();
}

var pps = 1;
var lastpos = 0;

function handleResponse( result ) {
      if (result.display) {
        if (result.first) {
          display = atob(result.display);
        } else {
          display = display + atob(result.display);
        }
        if (result.last) {
          var canvas = document.getElementById('display');
          var ctx = canvas.getContext('2d');
          rleDecode(ctx,display);
        }
      } else {
        $( "#mac" ).text(result.mac);
        $( "#tz" ).text(result.config.tz);
        $("#lastsync").text(new Date(1000*result.ntp.secs + result.ntp.usecs / 1000).toISOString());
        $("#now").text(new Date(1000*(result.time[0]) + result.time[1] / 1000).toISOString());
        $("#stop").prop('disabled', !result.running);        
        $("#start").prop('disabled', result.running);
        for (var i = 0; i < 3; i++) {
          $('#led' + i).css('background-color', '#' + result.leds[i]);
        }
        if (result.pos != lastpos) {
          $("#chr").val(result.hms[0]);
          $("#cmn").val(result.hms[1]);
          $("#csc").val(result.hms[2]);
          lastpos = result.pos;
        }
        pps = result.boardConfig.pps;
      }
}

function refresh() {
    var ws = new WebSocket("ws://" + window.location.host + "/data");
    ws.onmessage = function(event) {
      handleResponse(JSON.parse(event.data));
    };
}

function addleds() {
  var leds = $('#leds');
  for (var i = 0; i < 3; i++) {
    leds.append($('<span class=led id=led' + i + '></span>'));
  }
}

$(document).ready(function() {
  refresh();
});

$("#set").on('click', function() {
  var val = ($('#chr').val() * 3600 + $('#cmn').val() * 60 + $('#csc').val() * 1) * pps;
  $.ajax({
    url: "/set?pos=" + val,
    method: "POST",
    success: handleResponse
  });
});
$("#stop").on('click', function() {
  $.ajax({
    url: "/set?stop=1",
    method: "POST",
    success: handleResponse
  });
});
$("#start").on('click', function() {
  $.ajax({
    url: "/set?start=1",
    method: "POST",
    success: handleResponse
  });
});
</script>
</body></html>
